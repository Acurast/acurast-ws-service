---
include:
  - project: "papers/papers-internal/internal"
    file: "/.base-gitlab-ci.yml"

variables:
  NAMESPACE: "websocket-proxy"


stages:
  - build
  - test
  - publish
  - deploy


build:
  stage: build
  extends: .build

test:
  stage: test
  script:
    - docker run $GOOGLE_TAG bash -c "yarn run test"


publish-dev:
  stage: publish
  extends: .publish-dev

publish-prod:
  stage: publish
  extends: .publish-prod


.deployment_script:
  script:
    # seds
    - find k8s -type f -name \*.yaml -exec sed -i "s|__NAMESPACE_NAME__|"$NAMESPACE"|g" {} +
    - find k8s -type f -name \*.yaml -exec sed -i "s|_TO_BE_REPLACED_BY_IMAGE_TAG_|"$IMAGE_TAG"|g" {} +

    # applying the files
    - kubectl apply -f k8s/common/namespace.yaml
    # - kubectl apply -f k8s/common/secret.yaml
    - kubectl apply -f k8s/$CI_ENVIRONMENT_NAME/ --recursive
    - kubectl apply -f k8s/common/ --recursive



k8s-deploy-development:
  stage: deploy
  extends: .run_dev
  when: manual
  needs: ["publish-dev"]
  variables:
    IMAGE_TAG: $GOOGLE_TAG_DEV
  script:
    - !reference [.deployment_script, script]
  environment: 
    name: development
    url: https://websocket-proxy.dev.gke.papers.tech

k8s-deploy-production:
  stage: deploy
  when: manual
  extends: .run_prod
  needs: ["publish-prod"]
  variables:
    IMAGE_TAG: $GOOGLE_TAG
  script:
    - !reference [.deployment_script, script]
  environment: 
    name: production
    url: https://websocket-proxy.prod.gke.papers.tech
